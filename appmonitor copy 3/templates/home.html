{% extends "base.html" %}
{% block content %}

<style>
/* ===== ENTERPRISE UI ===== */

.page-title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 6px;
}

.subtitle {
    color: #6b7280;
    margin-bottom: 30px;
}

.card {
    background: #ffffff;
    border-radius: 14px;
    padding: 24px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.05);
    margin-bottom: 40px;
}

.card h2 {
    font-size: 20px;
    margin-bottom: 18px;
}

.styled-table {
    width: 100%;
    border-collapse: collapse;
}

.styled-table th {
    background: #f9fafb;
    color: #374151;
    font-size: 13px;
    text-transform: uppercase;
    padding: 14px;
    border-bottom: 1px solid #e5e7eb;
    text-align: center;
}

.styled-table th:first-child,
.styled-table td:first-child {
    text-align: left;
}

.styled-table td {
    padding: 14px;
    border-bottom: 1px solid #e5e7eb;
    font-size: 14px;
    text-align: center;
    vertical-align: middle;
}

/* ===== STATUS ===== */

.spinner {
    width: 16px;
    height: 16px;
    border: 3px solid #e5e7eb;
    border-top: 3px solid #facc15;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.status.ok {
    color: #16a34a;
    font-weight: 600;
}

.status.fail {
    color: #dc2626;
    font-weight: 600;
}

.status.pending {
    color: #6b7280;
    font-style: italic;
}

.tick {
    color: #16a34a;
    font-size: 20px;
    font-weight: 700;
}

.cross {
    color: #dc2626;
    font-size: 20px;
    font-weight: 700;
}

.note {
    font-size: 13px;
    color: #6b7280;
    margin-top: 10px;
}
</style>

<!-- ================= HEADER ================= -->

<div class="page-title">Application & Interface Health</div>
<p class="subtitle">
Live monitoring of applications and integrations (sequential checks)
</p>

<!-- ================= APPLICATION HEALTH ================= -->

<div class="card">
    <h2>Application Health</h2>

    <table class="styled-table">
        <thead>
            <tr>
                <th>System</th>
                <th>Environment</th>
                <th>Status</th>
                <th>Details</th>
            </tr>
        </thead>

        <tbody>
            {% for s in application_systems %}
            <tr id="app-{{ s.id }}">
                <td>{{ s.name }}</td>
                <td>{{ s.environment }}</td>
                <td class="app-status">
                    <span class="status pending">Yet to check</span>
                </td>
                <td class="user-count muted" data-system="{{ s.id }}">
                    Active Users: —
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" class="status pending">
                    No application monitors configured
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ================= INTERFACE HEALTH ================= -->

<div class="card">
    <h2>Interface / Integration Health</h2>

    <table class="styled-table">
        <thead>
            <tr>
                <th rowspan="2">System</th>
                <th colspan="2">Connectivity</th>
                <th colspan="2">Transactions (Last 24h)</th>
            </tr>
            <tr>
                <th>Outbound</th>
                <th>Inbound</th>
                <th>Outbound</th>
                <th>Inbound</th>
            </tr>
        </thead>

        <tbody>
            {% for s in interface_systems %}
            <tr id="if-{{ s.id }}">
                <td>{{ s.name }}</td>

                <td class="outbound-status">
                    <span class="status pending">Yet to check</span>
                </td>

                <td class="inbound-status">
                    <span class="status pending">Yet to check</span>
                </td>

                <td class="outbound-txn status pending">—</td>
                <td class="inbound-txn status pending">—</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="status pending">
                    No interface monitors configured
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<p class="note">
Systems are checked sequentially to avoid load and reflect real system state.
</p>

<!-- ================= SEQUENTIAL CHECK SCRIPT ================= -->

<script>
const applicationSystems = [
    {% for s in application_systems %}
    {{ s.id }}{% if not loop.last %},{% endif %}
    {% endfor %}
];

const interfaceSystems = [
    {% for s in interface_systems %}
    {{ s.id }}{% if not loop.last %},{% endif %}
    {% endfor %}
];

const wait = ms => new Promise(r => setTimeout(r, ms));

async function checkApplication(id) {
    const row = document.getElementById(`app-${id}`);
    const cell = row.querySelector(".app-status");

    cell.innerHTML = "<span class='spinner'></span>";

    try {
        const res = await fetch(`/health/${id}`);
        const data = await res.json();

        cell.innerHTML = data.ok
            ? "<span class='status ok'>✔ Healthy</span>"
            : "<span class='status fail'>✖ Issues Detected</span>";
    } catch {
        cell.innerHTML = "<span class='status fail'>✖ Unreachable</span>";
    }
}

async function checkInterface(id) {
    const row = document.getElementById(`if-${id}`);

    row.querySelector(".outbound-status").innerHTML = "<span class='spinner'></span>";
    row.querySelector(".inbound-status").innerHTML = "<span class='spinner'></span>";

    try {
        const res = await fetch(`/health/interface/${id}`);
        const data = await res.json();

        row.querySelector(".outbound-status").innerHTML =
            data.outbound.reachable ? "<span class='tick'>✔</span>" : "<span class='cross'>✖</span>";

        row.querySelector(".outbound-txn").innerText =
            `${data.outbound.total} (${data.outbound.failed} Failed)`;

        row.querySelector(".inbound-status").innerHTML =
            data.inbound.reachable ? "<span class='tick'>✔</span>" : "<span class='cross'>✖</span>";

        row.querySelector(".inbound-txn").innerText =
            `${data.inbound.total} (${data.inbound.failed} Failed)`;

    } catch {
        row.querySelector(".outbound-status").innerHTML = "<span class='cross'>✖</span>";
        row.querySelector(".inbound-status").innerHTML = "<span class='cross'>✖</span>";
        row.querySelector(".outbound-txn").innerText = "Error";
        row.querySelector(".inbound-txn").innerText = "Error";
    }
}

async function runSequentialChecks() {

    for (const id of applicationSystems) {
        await checkApplication(id);
        await wait(800);
    }

    for (const id of interfaceSystems) {
        await checkInterface(id);
        await wait(800);
    }
}

runSequentialChecks();
</script>

<script>
async function updateActiveUsers() {
    try {
        const res = await fetch("/metrics/active-users");
        const data = await res.json();

        document.querySelectorAll(".user-count").forEach(cell => {
            cell.innerHTML = `Active Users: <b>${data.active_users}</b>`;
        });

    } catch (err) {
        document.querySelectorAll(".user-count").forEach(cell => {
            cell.innerHTML = "Active Users: Error";
        });
    }
}

// initial load
updateActiveUsers();

// refresh every 2 seconds
setInterval(updateActiveUsers, 2000);
</script>


{% endblock %}
