{% extends "base.html" %}
{% block content %}

<style>
/* ===== SHELL-STYLE UI ===== */

.page-title {
    font-size: 26px;
    font-weight: 600;
    margin-bottom: 4px;
}

.subtitle {
    color: #6b7280;
    margin-bottom: 28px;
}

.card {
    background: #ffffff;
    border-radius: 12px;
    padding: 22px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    margin-bottom: 30px;
}

.card h2 {
    font-size: 18px;
    margin-bottom: 14px;
    font-weight: 600;
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
}

.metric {
    padding: 14px;
    border-radius: 10px;
    background: #f9fafb;
}

.metric-label {
    font-size: 13px;
    color: #6b7280;
}

.metric-value {
    font-size: 22px;
    font-weight: 600;
    margin-top: 6px;
}

/* ===== TABLE ===== */

.table-wrap {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background: #f9fafb;
    text-transform: uppercase;
    font-size: 12px;
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
}

td {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    font-size: 14px;
}

/* ===== STATUS ===== */

.status.pending {
    color: #6b7280;
    font-style: italic;
}

.status.ok {
    color: #16a34a;
    font-weight: 600;
}

.status.fail {
    color: #dc2626;
    font-weight: 600;
}

.spinner {
    width: 14px;
    height: 14px;
    border: 3px solid #e5e7eb;
    border-top: 3px solid #facc15;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<!-- ================= HEADER ================= -->

<div class="page-title">{{ app.name }}</div>
<div class="subtitle">Environment: {{ app.environment }}</div>

<!-- ================= APPLICATION METRICS ================= -->

<div class="card">
    <h2>Application Status</h2>

    <div class="grid">
        <div class="metric">
            <div class="metric-label">Application Health</div>
            <div id="app-health" class="metric-value status pending">
                Yet to check
            </div>
        </div>

        <div class="metric">
            <div class="metric-label">Active Users</div>
            <div id="app-users" class="metric-value status pending">
                —
            </div>
        </div>
    </div>
</div>

<!-- ================= INTERFACES ================= -->

<div class="card">
    <h2>Interfaces</h2>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Target Application</th>
                    <th>Outbound</th>
                    <th>Inbound</th>
                </tr>
            </thead>

            <tbody>
                {% for i in interfaces %}
                <tr data-interface="{{ i.id }}">
                    <td>{{ i.target_app_id }}</td>

                    <td class="outbound status pending">
                        Yet to check
                    </td>

                    <td class="inbound status pending">
                        Yet to check
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="3" class="status pending">
                        No interfaces configured
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ================= MONITORING SCRIPT ================= -->

<script>
const APP_ID = {{ app.id }};
const POLL_INTERVAL = 10000;

/* ---------- Helpers ---------- */
const wait = ms => new Promise(r => setTimeout(r, ms));

/* ---------- Application ---------- */
async function checkApplication() {
    const healthEl = document.getElementById("app-health");
    const usersEl = document.getElementById("app-users");

    healthEl.innerHTML = "<span class='spinner'></span>";
    usersEl.innerText = "—";

    try {
        const res = await fetch(`/api/app-health/${APP_ID}`);
        const data = await res.json();

        healthEl.innerHTML = data.healthy
            ? "<span class='status ok'>✔ Healthy</span>"
            : "<span class='status fail'>✖ Down</span>";

        usersEl.innerText = data.active_users;
    } catch {
        healthEl.innerHTML = "<span class='status fail'>✖ Error</span>";
        usersEl.innerText = "Error";
    }
}

/* ---------- Interfaces ---------- */
async function checkInterfacesSequential() {
    const rows = document.querySelectorAll("tr[data-interface]");

    for (const row of rows) {
        const id = row.dataset.interface;

        const outCell = row.querySelector(".outbound");
        const inCell = row.querySelector(".inbound");

        outCell.innerHTML = "<span class='spinner'></span>";
        inCell.innerHTML = "<span class='spinner'></span>";

        try {
            const res = await fetch(`/api/interface-health/${id}`);
            const data = await res.json();

            if (data.outbound) {
                outCell.innerHTML = data.outbound.reachable
                    ? `<span class="status ok">✔ ${data.outbound.total} (${data.outbound.failed} failed)</span>`
                    : `<span class="status fail">✖</span>`;
            } else {
                outCell.innerText = "—";
            }

            if (data.inbound) {
                inCell.innerHTML = data.inbound.reachable
                    ? `<span class="status ok">✔ ${data.inbound.total} (${data.inbound.failed} failed)</span>`
                    : `<span class="status fail">✖</span>`;
            } else {
                inCell.innerText = "—";
            }

        } catch {
            outCell.innerHTML = "<span class='status fail'>Error</span>";
            inCell.innerHTML = "<span class='status fail'>Error</span>";
        }

        await wait(700);   // sequential illusion
    }
}

/* ---------- INITIAL LOAD ---------- */
(async function init() {
    await checkApplication();
    await wait(800);
    await checkInterfacesSequential();
})();

/* ---------- BACKGROUND POLLING ---------- */
setInterval(checkApplication, POLL_INTERVAL);
setInterval(checkInterfacesSequential, POLL_INTERVAL);
</script>

{% endblock %}
