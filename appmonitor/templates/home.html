{% extends "base.html" %}
{% block content %}

<style>
.page-title {
    font-size: 26px;
    font-weight: 600;
    margin-bottom: 6px;
}

.subtitle {
    color: #6b7280;
    margin-bottom: 24px;
}

.card {
    background: #ffffff;
    border-radius: 12px;
    padding: 22px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    margin-bottom: 30px;
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 18px;
}

.metric {
    font-size: 22px;
    font-weight: 700;
}

.status-ok { color: #16a34a; }
.status-fail { color: #dc2626; }
.status-pending { color: #6b7280; }

.spinner {
    width: 16px;
    height: 16px;
    border: 3px solid #e5e7eb;
    border-top: 3px solid #facc15;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.table-wrap {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background: #f9fafb;
    font-size: 12px;
    text-transform: uppercase;
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
}

td {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    font-size: 14px;
}

.tick { color: #16a34a; font-weight: 700; }
.cross { color: #dc2626; font-weight: 700; }
.pending { color: #6b7280; }

.ok { color: #16a34a; font-weight: 700; }
.fail { color: #dc2626; font-weight: 700; }
.muted { color: #6b7280; font-style: italic; }

.fail-count { color: #dc2626; font-weight: 600; }
.zero-count { color: #6b7280; }

.tooltip {
    position: relative;
    cursor: help;
}

.tooltip:hover::after {
    content: attr(data-tip);
    position: absolute;
    left: 0;
    top: 120%;
    background: #111827;
    color: #fff;
    padding: 6px 10px;
    font-size: 12px;
    border-radius: 6px;
    white-space: nowrap;
    z-index: 20;
}

</style>

<!-- ================= HEADER ================= -->

<div class="page-title">
{{ app.name }} — {{ app.environment }}
</div>

<p class="subtitle">
Live application & interface monitoring
</p>

<!-- ================= APP METRICS ================= -->

<div class="card">
<div class="grid">

<div>
<div>Application Health</div>
<div id="app-health" class="metric status-pending">
<span class="spinner"></span>
</div>
</div>

<div>
<div>Active Users</div>
<div id="active-users" class="metric status-pending">
—
</div>
</div>

</div>
</div>

<!-- ================= INTERFACES ================= -->

<div class="card">

<h3 style="margin-bottom:16px;">Interfaces</h3>

<div class="table-wrap">
<table>

<thead>
<tr>
<th>Target System</th>
<th>Direction</th>
<th>Inbound</th>
<th>Outbound</th>
</tr>
</thead>

<tbody>

{% for i in interfaces %}
<tr id="if-{{ i.id }}">

<td>{{ i.target_system_name }}</td>
<td>{{ i.direction }}</td>

<td class="inbound pending">
<span class="spinner"></span>
</td>

<td class="outbound pending">
<span class="spinner"></span>
</td>

</tr>
{% else %}
<tr>
<td colspan="4" class="pending">
No interfaces configured
</td>
</tr>
{% endfor %}

</tbody>

</table>
</div>

</div>

<!-- ================= JAVASCRIPT ================= -->

<script>

const appId = {{ app.id }};
const interfaces = [
{% for i in interfaces %}
{{ i.id }}{% if not loop.last %},{% endif %}
{% endfor %}
];

const wait = ms => new Promise(r => setTimeout(r, ms));

/* ===== APPLICATION HEALTH ===== */

async function checkApp() {
    const health = document.getElementById("app-health");
    const users = document.getElementById("active-users");

    health.innerHTML = "<span class='spinner'></span>";

    try {
        const res = await fetch(`/api/app-health/${appId}`);
        const data = await res.json();

        health.innerHTML = data.healthy
            ? "<span class='status-ok'>✔ Healthy</span>"
            : "<span class='status-fail'>✖ Down</span>";

        users.innerHTML = data.active_users;

    } catch {
        health.innerHTML = "<span class='status-fail'>✖ Error</span>";
        users.innerHTML = "Error";
    }
}

/* ===== INTERFACE HEALTH ===== */

async function checkInterface(id) {
    const row = document.getElementById(`if-${id}`);
    const inboundCell = row.querySelector(".inbound");
    const outboundCell = row.querySelector(".outbound");

    inboundCell.innerHTML = "<span class='spinner'></span>";
    outboundCell.innerHTML = "<span class='spinner'></span>";

    try {
        const res = await fetch(`/api/interface-health/${id}`);
        const data = await res.json();

        // ---------- INBOUND ----------
        if (!data.inbound) {
            inboundCell.innerHTML = "<span class='muted'>Not configured</span>";
        } else {
            const ok = data.inbound.reachable;
            const failed = data.inbound.failed;
            const failedClass = failed > 0 ? "fail-count" : "zero-count";

            inboundCell.innerHTML = `
                <span class="tooltip ${ok ? "ok" : "fail"}"
                      data-tip="${data.inbound.total} transactions, ${failed} failed">
                    ${ok ? "✔" : "✖"} ${data.inbound.total}
                    <span class="${failedClass}">(${failed})</span>
                </span>`;
        }

        // ---------- OUTBOUND ----------
        if (!data.outbound) {
            outboundCell.innerHTML = "<span class='muted'>Not configured</span>";
        } else {
            const ok = data.outbound.reachable;
            const failed = data.outbound.failed;
            const failedClass = failed > 0 ? "fail-count" : "zero-count";

            outboundCell.innerHTML = `
                <span class="tooltip ${ok ? "ok" : "fail"}"
                      data-tip="${data.outbound.total} transactions, ${failed} failed">
                    ${ok ? "✔" : "✖"} ${data.outbound.total}
                    <span class="${failedClass}">(${failed})</span>
                </span>`;
        }

    } catch {
        inboundCell.innerHTML = "<span class='fail'>Error</span>";
        outboundCell.innerHTML = "<span class='fail'>Error</span>";
    }
}

/* ===== SEQUENTIAL LOADING ===== */

async function runSequential() {
    await checkApp();
    await wait(600);

    for (const id of interfaces) {
        await checkInterface(id);
        await wait(600);
    }
}

/* ===== AUTO REFRESH ===== */

runSequential();
setInterval(runSequential, 30000);

</script>

{% endblock %}
